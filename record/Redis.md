# Redis

Redis (Remote Dictionary Server)，是非关系型内存键值数据库，由 C 语言写成。

## 特点

- 速度快
- 数据类型丰富
- 支持事务
- 提供持久化
- 特性丰富，可用于缓存，消息等

## Key-Value

Key 的类型只能是 String，而 Value 可以是 String，List，Set，Hash，ZSet。

## 事务

Redis 是通过 MULTI 、 DISCARD 、 EXEC 和 WATCH 四个命令来实现事务功能的。

## 字典

也叫映射或者关联数组，一种抽象的数据结构，由键值对组成。Redis 字典中有两个哈希表，用来进行再哈希。

### 应用

- 实现数据库的键空间
- 用作 hash 类型键的底层实现

其中，hash 类型键使用字典和压缩列表两种数据结构作为底层实现。

### 实现

字典的实现方式有以下几种，但在 Redis 中使用了哈希表作为底层实现。

- 链表或者数组，但仅适合在元素个数不多的情况
- 哈希表，简单，效率高
- 平衡树，性能稳定

## 跳跃表

跳跃表是一种随机化的多层链表结构。跳跃表是由表头、跳跃表节点、层和表尾组成。

### 应用

其唯一应用就是实现有序集数据类型。

### 特点

- 一个跳表有多个层组成
- 跳表的第一层包含链表的所有元素
- 每一层都是一个有序链表
- 若元素 x 在第 i 层，则所有的比 i 小的层都包含元素 x
- 每个节点都包含 key 及其对应的 value 和一个指向同一层链表的下个节点的指针数组

### Redis 中跳跃表的特点

- score 的值可重复
- 对比一个元素需要同时检查它的 score 和 member
- 每个节点都带有高度为 1 层的后退指针，用于从表尾方向想表头方向迭代

## 过期键删除策略

- 定时删除：设置一个定时器，达到过期时间则删除，需占用大量 CPU 资源
- 惰性删除：访问某个 key 时再判断该 key 是否过期，过期则删除，会消耗大量内存
- 定期删除：每个一段时间就扫描一下过期键字典，然后删除部分过期键


## 缓存淘汰策略

- volatile-lru：从已经设置过期的数据集中挑选最近最少使用的数据进行淘汰。
- volatile-ttl：从已经设置过期时间的数据集中挑选将要过期的数据进行淘汰。
- volatile-random：从已经设置过期时间的数据集中任意选择数据进行淘汰。
- allkeys-lru：从所有数据集中挑选最近最少使用的数据进行淘汰。
- allkeys-random：从所有数据集中任意挑选数据进行淘汰。
- no-enviction：禁止驱逐数据。
- lfu

## Redis 持久化的方式

- 快照(RDB)：RDB 将数据库的快照（snapshot）以二进制的方式保存到磁盘中。
- AOF (Append-only File)：AOF 则以协议文本的方式，将所有对数据库进行过写入的命令（及其参数）记录到 AOF 文件，以此达到记录数据库状态的目的。
- 虚拟内存

## 缓存雪崩

Redis 因为某种原因挂掉了，或者对缓存数据设置了相同的过期时间，导致某段时间内缓存失效，最终使得请求的数据全部去了数据库，这就是缓存雪崩。

### 解决办法

针对后一种情况，我们可以在缓存数据的时候给过期时间加上一个随机值，这样就会大幅度的减少缓存在同一时间过期。

而针对前一种情况，我们可以分为以下几种方式来解决：

- 事发前：实现 Redis 的高可用 (主从架构 + Sentinel 或者 Redis Cluster)，尽量避免 Redis 挂掉这种情况发生。
- 事发中：设置本地缓存 (ehcache) 和限流 (hystrix)，以此保证服务可以正常运行。
- 事发后：Redis 持久化，重启后自动从磁盘上加载数据，快速恢复缓存数据。

## 缓存穿透

缓存穿透是指查询一个一定不存在的数据，即请求的数据在缓存中大量不命中，导致请求走数据库。

由于缓存不命中，并且出于容错考虑，如果从数据库查不到数据则不写入缓存，这将导致这个不存在的数据每次请求都要到数据库去查询，失去了缓存的意义。

### 解决方法

- 使用布隆过滤器 BloomFilter 或者压缩 filter 提前拦截，将不合法的请求拒之门外。
- 当我们从数据库找不到的时候，也将这个空对象设置到缓存里边去。下次再请求的时候，就可以从缓存里边获取了。

## 应用场景

- 会话缓存
- 全页缓存
- 队列
- 排行榜/计数器
- 发布/订阅

## 可能会问到的面试题

- 如何防止数据出错（Redis 事务）
- 如何使用流水线来提升性能
- Redis 主从复制
- Redis 集群的搭建
- Redis 的几种淘汰策略
- Redis 集群宕机，数据迁移问题

## Ref

- [https://www.hoohack.me/2019/06/24/redis-expire-strategy](https://www.hoohack.me/2019/06/24/redis-expire-strategy)
- [Redis 设计与实现](https://docs.pythontab.com/redis/redisbook/index.html)
- [https://juejin.im/post/5ad6e4066fb9a028d82c4b66](https://juejin.im/post/5ad6e4066fb9a028d82c4b66)
- [https://www.imooc.com/article/36399](https://www.imooc.com/article/36399)
- [https://zhuanlan.zhihu.com/p/32540678](https://zhuanlan.zhihu.com/p/32540678)
- [https://segmentfault.com/a/1190000014507534](https://segmentfault.com/a/1190000014507534)
- [https://my.oschina.net/u/3777556/blog/3001143](https://my.oschina.net/u/3777556/blog/3001143)




